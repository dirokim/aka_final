<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.aka.app.edms.EdmsDAO">

	
<!-- 	<insert id="createEdms" parameterType="EdmsVO">
	
		INSERT INTO EDMS (EDMS_NO, EDMS_FORM_NO, EDMS_CREATOR, EDMS_TITLE, EDMS_CONTENT, EDMS_STATUS, EDMS_APPROVAL_DATE, EDMS_CREATE_DATE, EDMS_EXP_DATE, EDMS_USE, EDMS_EXTRA_DATE1, EDMS_EXTRA_DATE2, EDMS_EXTRA_COINTENTS, EDMS_EXTRA_NUMBER, EDMS_CREATOR_POSITION)
					VALUES(NEXTVAL(EDMS_SEQ), edmsFromNo, edmsCreator, edmsTitle, ,edmsContent, edmsStatus, edmsApplovalDate, edmsCreateDate, edmsExpDate, edms_use, edmsExtraDate1, edmsExtraDate2, edmsExtraContent, edmsExtraNumber, edmsCreatorPosition)
	</insert> -->

<!-- 문서저장  -->
	<insert id="createEdms" parameterType="EdmsVO">
		<selectKey keyProperty="edms_No" resultType="Long" order="BEFORE">
		<!-- EDMS_NO 동시사용  -->
			SELECT MAX(EDMS_NO) FROM EDMS
		</selectKey>
			INSERT INTO EDMS (EDMS_NO, EDMS_FORM_NO, EDMS_CREATOR, EDMS_TITLE, EDMS_CONTENT, EDMS_STATUS, EDMS_CREATE_DATE, EDMS_CREATOR_POSITION)
				VALUES(NEXTVAL(EDMS_SEQ), #{edms_From_No}, #{edms_Creator}, #{edms_Title}, #{edms_Content}, #{edms_Status}, NOW(), #{edms_Creator_Position})
	</insert>
	
	<insert id="createApproval" parameterType="java.util.List">
		
		INSERT INTO APRROVAL( EDMS_NO ,MEMBER_ID ,APPROVAL_RANK)
					VALUES
		<foreach collection="list" index="index" item="member"  separator=",">
					( #{member.EDMS_NO}, #{member.MEMBER_ID}, #{member.APPROVAL_RANK})
		</foreach>
		
	</insert>
	<insert id="createEdmsAttchFile" parameterType="List">
			INSERT INTO EDMS_ATTECHFILE (EDMS_NO, EDMS_ATTECHFILE_NAME,EDMS_ATTECHFILE_ORI_NAME)
		<foreach collection="list" index="index" item="EdmsFileVO"  separator=",">
				VALUES(#{EdmsFileVO.edms_No}, #{EdmsFileVO.edms_Attechfile_Name}, #{EdmsFileVO.edms_AttechfileOri_Name})
		</foreach>
	</insert>

<!-- 문서 불러오기  -->


	<select id="getDetail" parameterType="EdmsVO" resultType="Map">
		
		SELECT * FROM EDMS e 

			LEFT JOIN `MEMBER` m 
			ON e.EDMS_CREATOR =  m.MEMBER_ID 
		
		WHERE e.EDMS_NO  = #{edms_No}
		
		
	</select>


<!-- 결재선 가져오기 -->

<select id="applineList" parameterType="EdmsVO" resultType="Map">

		SELECT * SELECT * FROM APRROVAL a  
	

</select>

	
	
		


		<!-- 검색 -->
		 <sql id="search">
		  	
		  		<choose>
		  			
		  			<when test="Pager.kind=='kind1'">AND EDMS_CONTENT</when>  			
		  			<otherwise>AND EDMS_TITLE</otherwise>  			
		  		</choose>  
		  		LIKE CONCAT('%', #{Pager.search}, '%')
		  	 		
		 </sql>
		  <sql id="searchDone">
		  	WHERE
		  		<choose>
		  			
		  			<when test="Pager.kind=='kind1'">EDMS_CONTENT</when>
		  			<when test="Pager.kind=='kind2'">EDMS_STATUS = 5</when>  
		  			<when test="Pager.kind=='kind3'">EDMS_STATUS = 3</when>    			
		  			<otherwise>EDMS_TITLE</otherwise>  			
		  		</choose>  
		  		LIKE CONCAT('%', #{Pager.search}, '%')
		  	 		
		 </sql>
		
	<!-- 결재목록 가져오기 -->	
		<select id="getEdmsList" parameterType="Map" resultType="EdmsVO">
		
			SELECT * FROM EDMS WHERE EDMS_CREATOR = #{MemberVO.member_id}
			
			 <include refid="search">	
				
			</include> 
			ORDER BY EDMS_NO DESC
			LIMIT #{Pager.startIndex},#{Pager.perPage}
			
		</select>
		
		
		
		<select id="getEdmsTotalCount" resultType="Long" parameterType="Map">
			
			SELECT COUNT(EDMS_NO) FROM EDMS WHERE EDMS_CREATOR = #{MemberVO.member_id} 	
			 <include refid="search">
			</include>
			
		</select>

<!-- 결재완료 문서 가져오기  -->
		
	<select id="getEdmsDoneList" resultType="EdmsVO" parameterType="Map">
	
		SELECT * FROM
		(SELECT * FROM EDMS GROUP BY EDMS_CREATOR HAVING EDMS_CREATOR = 4 AND (EDMS_STATUS = 5 OR EDMS_STATUS = 3))E
		<include refid="searchDone"></include>
	
	</select>
	
	<select id="getEdmsDoneTotalCount" resultType="Long" parameterType="Map">
		
		SELECT COUNT(EDMS_NO) FROM 
		(SELECT * FROM EDMS GROUP BY EDMS_CREATOR HAVING EDMS_CREATOR = 4 AND (EDMS_STATUS = 5 OR EDMS_STATUS = 3))E
		<include refid="searchDone"></include>
		
	</select>
		
<!-- 수신결재  -->
	
	
	<select id="getReciveEdmsList" parameterType="Map" resultType="EdmsVO">
		SELECT * FROM APRROVAL 
			LEFT JOIN EDMS e 
			USING (EDMS_NO)
		WHERE MEMBER_ID = #{MemberVO.member_id}  AND APRROVAL_RESULT = 1
			
			 <include refid="search">	
				
			</include> 
			ORDER BY EDMS_NO DESC
			LIMIT #{Pager.startIndex},#{Pager.perPage}
			
		</select>
		
		
		
		<select id="getReciveEdmsTotalCount" resultType="Long" parameterType="Map">
			
			SELECT COUNT(EDMS_NO) FROM APRROVAL 
				LEFT JOIN EDMS e 
				USING (EDMS_NO)
			WHERE MEMBER_ID = #{MemberVO.member_id}  AND APRROVAL_RESULT = 1

			 <include refid="search">
			</include>
			
		</select>
	<!-- 결재내역  -->
	
	
	<select id="getAprovedEdmsList" parameterType="Map" resultType="EdmsVO">
		SELECT * FROM APRROVAL 
			LEFT JOIN EDMS e 
			USING (EDMS_NO)
		WHERE MEMBER_ID = #{MemberVO.member_id}  AND APRROVAL_RESULT = 1
			
			 <include refid="search">	
				
			</include> 
			ORDER BY EDMS_NO DESC
			LIMIT #{Pager.startIndex},#{Pager.perPage}
			
		</select>
		
		
		
		<select id="getAprovedEdmsTotalCount" resultType="Long" parameterType="Map">
			
			SELECT COUNT(EDMS_NO) FROM APRROVAL 
				LEFT JOIN EDMS e 
				USING (EDMS_NO)
			WHERE MEMBER_ID = #{MemberVO.member_id}  AND APRROVAL_RESULT = 3 AND APRROVAL_RESULT = 5

			 <include refid="search">
			</include>
			
		</select>



	
	

<!-- 임시문서 --> 

<!-- 임시문서 삭제  -->

	<delete id="delectTempEdms" parameterType="EdmsVO">
	
		DELETE FROM TEMP_EDMS WHERE EDMS_NO = ${edms_No}
	
	</delete>
<!-- 임시문서 업데이트  -->

	<update id="updateTempEdms" parameterType="EdmsVO">
	
		
		UPDATE TEMP_EDMS SET EDMS_FORM_NO = edms_From_No							
							,EDMS_TITLE = edms_Title
							,EDMS_CONTENT = edms_Content											
							,EDMS_CREATE_DATE = NOW()							
							,EDMS_EXTRA_DATE1 = edms_Extra_Date1
							,EDMS_EXTRA_DATE2 = edms_Extra_Date2
							,EDMS_EXTRA_COINTENTS = edms_Extra_Content
							,EDMS_EXTRA_NUMBER = edms_Extra_Number
							,EDMS_CREATOR_POSITION = edms_Creator_Position
		WHERE EDMS_NO = edms_No							
									
	
	</update>




<!-- 임시문서 저장  -->

	<insert id="createTempEdms" parameterType="EdmsVO">
		<selectKey keyProperty="edms_No" resultType="Long" order="BEFORE"> 
		<!-- EDMS_NO 동시사용  -->
			SELECT MAX(EDMS_NO) FROM TEMP_EDMS
		</selectKey>
			INSERT INTO TEMP_EDMS (EDMS_FORM_NO, EDMS_CREATOR, EDMS_TITLE, EDMS_CONTENT, EDMS_STATUS, EDMS_CREATE_DATE, EDMS_CREATOR_POSITION)
				VALUES(#{edms_From_No}, #{edms_Creator}, #{edms_Title}, #{edms_Content}, #{edms_Status}, #{edms_Create_Date}, #{edms_Creator_Position})
	</insert>
	
	<insert id="createTempApproval" parameterType="java.util.List">
		
		INSERT INTO TEMP_APRROVAL(EDMS_NO ,MEMBER_ID ,APPROVAL_RANK)
					VALUES
		<foreach collection="list" index="index" item="member"  separator=",">
					(#{member.EDMS_NO}, #{member.MEMBER_ID}, #{member.APPROVAL_RANK})
		</foreach>
		
	</insert>
	<insert id="createTempEdmsAttchFile" parameterType="List">
			INSERT INTO TEMP_EDMS_ATTECHFILE (EDMS_NO, EDMS_ATTECHFILE_NAME	,EDMS_ATTECHFILE_ORI_NAME)
		<foreach collection="list" index="index" item="EdmsFileVO"  separator=",">
				VALUES(#{EdmsFileVO.edms_No}, #{EdmsFileVO.edms_Attechfile_Name}, #{EdmsFileVO.edms_AttechfileOri_Name})
		</foreach>
	</insert>


<!-- 임시문서 불러오기  -->


	<select id="getTempDetail" parameterType="EdmsVO" resultType="Map">
		
		SELECT * FROM TEMP_EDMS te 

			LEFT JOIN `MEMBER` m 
			ON te.EDMS_CREATOR =  m.MEMBER_ID 
		
		WHERE te.EDMS_NO  = #{edms_No}
		
		
	</select>


		

<!-- 임시결재목록 가져오기 --> 
		
		
		<select id="getTempEdmsList" parameterType="Map" resultType="EdmsVO">
		
			SELECT * FROM TEMP_EDMS WHERE EDMS_CREATOR = #{MemberVO.member_id}
			
			 <include refid="search">	
				
			</include> 
			ORDER BY EDMS_NO DESC
			LIMIT #{Pager.startIndex},#{Pager.perPage}
			
		</select>
		
		
		
		<select id="getTempEdmsTotalCount" resultType="Long" parameterType="Map">
			
			SELECT COUNT(EDMS_NO) FROM TEMP_EDMS WHERE EDMS_CREATOR = #{MemberVO.member_id} 	
			 <include refid="search">
			</include>
			
		</select>
			


	








<!-- 로그인한 사용자 부서이름 가져오기  -->

	<select id="getDeptName" parameterType="MemberVO" resultType="Map">
		
		SELECT MEMBER_ID, DEPARTMENT_NAME, POSITION_NAME FROM `MEMBER` m 
			JOIN DEPARTMENT d 
			USING (DEPARTMENT_ID)
			JOIN POSITIONRANK p 
			USING (POSITION_ID)
		WHERE MEMBER_ID = #{member_id}
	
	</select>

<!-- 결재선 직원 불러오기  -->

	<select id="getMemberList" resultType="Map">
		
		SELECT MEMBER_ID, USERNAME, DEPARTMENT_ID, DEPARTMENT_SUPER_ID , DEPARTMENT_NAME , POSITION_ID, POSITION_NAME FROM `MEMBER` m 
			JOIN DEPARTMENT d 
			USING (DEPARTMENT_ID)
			JOIN POSITIONRANK p 
			USING (POSITION_ID);
					
	
	</select>
	
	
<!-- 부서정보 가져오기  -->

	<select id="getDeptChart" resultMap="deptList">
	
	 WITH RECURSIVE CTE AS (
		    SELECT 
		        DEPARTMENT_ID, 
		        DEPARTMENT_NAME, 
		        DEPARTMENT_SUPER_ID, 
		        0 AS depth,
		        CAST(DEPARTMENT_ID AS CHAR(200)) AS path
		    FROM 
		        DEPARTMENT
		    WHERE 
		        DEPARTMENT_SUPER_ID = 0
		
		    UNION ALL
		
		    SELECT 
		        d.DEPARTMENT_ID, 
		        d.DEPARTMENT_NAME, 
		        d.DEPARTMENT_SUPER_ID, 
		        depth + 1, 
		        CONCAT(CTE.path, ',', d.DEPARTMENT_ID)
		    FROM 
		        DEPARTMENT d
		    INNER JOIN 
		        CTE ON d.DEPARTMENT_SUPER_ID = CTE.DEPARTMENT_ID
		)
		SELECT * FROM  CTE
	 
	 
	</select>
	<select id="getMemberChart" resultMap="memberList">
		SELECT MEMBER_ID+1000 id, CONCAT(POSITION_NAME,' ',USERNAME) text, DEPARTMENT_ID, MEMBER_ID, POSITION_NAME, USERNAME, DEPARTMENT_NAME FROM `MEMBER` m 
				JOIN DEPARTMENT d 
				USING (DEPARTMENT_ID)
				JOIN POSITIONRANK p 
				USING (POSITION_ID)
	</select>

	<resultMap type="Map" id="memberList">
		<id column="id" property="id" javaType="String"/>	
		<result column="DEPARTMENT_ID" property="parent"  javaType="String"/>		
		<result column="DEPARTMENT_NAME" property="dept" javaType="String"/>
	</resultMap>


	<resultMap type="Map" id="deptList">
		<id column="DEPARTMENT_ID" property="id" javaType="String"/>
		<result column="DEPARTMENT_NAME" property="text"  javaType="String"/>
		<result column="DEPARTMENT_SUPER_ID" property="parent"  javaType="String"/>		
	</resultMap>
	
</mapper>

